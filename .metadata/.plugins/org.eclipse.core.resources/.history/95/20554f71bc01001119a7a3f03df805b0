package com.teknikos.WestgateMobileApp.base;

import java.net.MalformedURLException;
import java.net.URL;
import java.time.Duration;

import org.testng.annotations.AfterClass;
import org.testng.annotations.BeforeClass;
import com.teknikos.WestgateMobileApp.core.DriverManager;
import com.teknikos.WestgateMobileApp.config.ConfigReader;
import com.teknikos.WestgateMobileApp.utils.ExtentReportManager;
import io.appium.java_client.android.AndroidDriver;
import io.appium.java_client.android.options.UiAutomator2Options;
import io.appium.java_client.service.local.AppiumDriverLocalService;

public class BaseTest extends ExtentReportManager {

    @BeforeClass
    public void configureAppium() throws MalformedURLException {
        System.out.println("üì± Initializing Appium driver...");

        boolean startAppiumServer = ConfigReader.getBoolean("startAppiumServer");
        String appiumServerUrl = ConfigReader.get("appiumServerUrl");
        String platformName = ConfigReader.get("platformName");
        String platformVersion = ConfigReader.get("platformVersion");
        String deviceName = ConfigReader.get("deviceName");
        String appPath = ConfigReader.get("appPath");

        if (startAppiumServer) {
            AppiumDriverLocalService service = AppiumDriverLocalService.buildDefaultService();
            service.start();
            System.out.println("‚úÖ Appium server started.");
            DriverManager.setService(service);
        }

        UiAutomator2Options options = new UiAutomator2Options()
                .setPlatformName(platformName)
                .setPlatformVersion(platformVersion)
                .setDeviceName(deviceName)
                .setApp(appPath);

        try {
            AndroidDriver driver = new AndroidDriver(new URL(appiumServerUrl), options);
            driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(30));
            System.out.println("‚úÖ App launched.");
            DriverManager.setDriver(driver);
        } catch (Exception e) {
            System.err.println("‚ùå Failed to initialize AndroidDriver: " + e.getMessage());
            throw new RuntimeException("Driver launch failed", e);
        }
    }

    @AfterClass
    public void tearDown() {
        DriverManager.quitDriver();
        DriverManager.stopService();
    }
}
