package com.teknikos.WestgateMobileApp.utils;

import java.io.File;
import java.nio.file.Paths;

import com.aventstack.extentreports.*;
import com.aventstack.extentreports.reporter.ExtentSparkReporter;
import com.aventstack.extentreports.reporter.configuration.Theme;

public class ExtentReportManager {

    private static ExtentReports extent;
    private static final ThreadLocal<ExtentTest> test = new ThreadLocal<>();

    /**
     * Initializes the Extent Report and Spark Reporter
     */
    public static void setupReport() {
        try {
            String reportDir = Paths.get(System.getProperty("user.dir"), "reports").toString();
            String reportPath = Paths.get(reportDir, "ExtentReport.html").toString();

            File reportDirectory = new File(reportDir);
            if (!reportDirectory.exists() && !reportDirectory.mkdirs()) {
                throw new RuntimeException("Failed to create reports directory");
            }

            ExtentSparkReporter sparkReporter = new ExtentSparkReporter(reportPath);
            sparkReporter.config().setDocumentTitle("Mobile ID Automation Report");
            sparkReporter.config().setReportName("Test Execution Report");
            sparkReporter.config().setTheme(Theme.STANDARD);
            sparkReporter.config().setCss(
                    ".report-name { font-size: 24px; font-weight: bold; } " +
                    ".step-details { font-size: 16px; } " +
                    ".nav-wrapper { width: 350px; } " +
                    ".badge { font-size: 14px; }"
            );

            extent = new ExtentReports();
            extent.attachReporter(sparkReporter);

            extent.setSystemInfo("Tester", "QA Engineer");
            extent.setSystemInfo("OS", System.getProperty("os.name"));
            extent.setSystemInfo("Java Version", System.getProperty("java.version"));

        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException("Failed to initialize Extent Reports: " + e.getMessage());
        }
    }

    /**
     * Starts a new test and sets the thread-local instance.
     */
    public static void startTest(String testName, String description) {
        ExtentTest extentTest = extent.createTest(testName, description);
        test.set(extentTest);
    }

    public static void logInfo(String message) {
        test.get().log(Status.INFO, message);
    }

    public static void logPass(String message) {
        test.get().log(Status.PASS, message);
    }

    public static void logFail(String message) {
        test.get().log(Status.FAIL, message);
    }

    public static void logFail(String message, Throwable throwable) {
        test.get().log(Status.FAIL, message);
        test.get().log(Status.FAIL, throwable);
    }

    /**
     * Logs screenshot with optional message
     */
    public static void logScreenshot(String message, String screenshotPath) {
        try {
            test.get().info(message, MediaEntityBuilder.createScreenCaptureFromPath(screenshotPath).build());
        } catch (Exception e) {
            e.printStackTrace();
            test.get().fail("Failed to attach screenshot: " + e.getMessage());
        }
    }

    /**
     * Flushes and finalizes the report
     */
    public static void tearDownReport() {
        if (extent != null) {
            extent.flush();
        }
    }

    /**
     * Returns the shared ExtentReports instance
     */
    public static ExtentReports getReportInstance() {
        return extent;
    }

    /**
     * Clears the thread-local after test execution
     */
    public static void clearTest() {
        test.remove();
    }
}

